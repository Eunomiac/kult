import{gsap as t,Flip as i,MotionPathPlugin as e,RoughEase as s}from"./external/greensock/all.js";import r from"./utilities.js";import a from"./constants.js";import{SessionData as n,SetPhase as h,Update as o,ghostPopText as c}from"../kult.js";import d from"./tarot-deck.js";export default class u{static t(){t.i({name:"cardWander",effect:i=>{const e=t.timeline();return e.to(i,{x:(i,e)=>t.h(e,"x")+t.o.random(-150,150),u:"sine.inOut",duration:3,l:{repeat:-1,p:!0,g:3,u:"rough({ strength: 0.5, points: 20, template: none.inOut, taper: none, randomize: true, clamp: false })",from:"random"}}),e.to(i,{y:(i,e)=>t.h(e,"y")+t.o.random(-50,50),u:"sine.inOut",duration:3,l:{repeat:-1,p:!0,g:3,u:"rough({ strength: 0.5, points: 20, template: none.inOut, taper: none, randomize: true, clamp: false })",from:"random"}},0),e}})}constructor(t,i,e){this.m=t,this.k=i,this.$=a.v.height,this.S=a.v.width,this.j=e,this.O=this.C.x,this.I=this.C.y,this.P=i*(a.M/67),[this.Z]=$(`<div id="${this.id}" class="tarot-card tarot-card-main tarot-card-${this.C.type}" data-card-num="${this.B}"></div>`).appendTo("#card-layer")}get C(){return this.j}get data(){return this.m}get x(){return this.O=this.O??this.C.x}get y(){return this.I=this.I??this.C.y}get z(){return this.P=this.P??this.C.z}get height(){return this.$}get width(){return this.S}get id(){return`card-main-${this.C.type}-${this.B}`}get selector(){return`#${this.id}`}get B(){return this.k}get D(){return this.Z??!1}get F(){return this.R=this.R??r.U(`${this.C.type}/card-back-${t.o.random(1,a.X[this.C.type],1)}.webp`)}get name(){return this.data.name}get _(){return(this.data._??"major-arcana").toLowerCase()}get H(){return(this.data.H??this._).toLowerCase()}get T(){return"major-arcana"===this._?"major":"minor"}get G(){return this.data.G}get slot(){return this.N}set slot(t){this.N=t,this.O=a.W[t].x,this.I=a.W[t].y,this.P=0}get angle(){return!!this.q&&r.A(this.q,t.h($(this.D).parent()[0],"rotationZ"))}get J(){return this.K?r.U(this.m.L):this.F}get K(){return n.V[this.slot]?.K}set K(t){n.V[this.slot].K=Boolean(t)}get Y(){return this.K||!n.tt?0:Math.max(0,this.slot-n.tt)}get it(){return this.K?Object.entries(this.m.et).filter((([t,i])=>n.et.st[t])).map((([t,i])=>i)).flat():[]}rt(){this.O=t.h(this.D,"x"),this.I=t.h(this.D,"y"),this.P=t.h(this.D,"z"),[this.nt]=$(this.D).parent()}ht(i){if(n.ot)return!1;switch(n.ct){case"cardsInOrbit":return i.preventDefault(),this.dt(),!0;case"cardsDealt":if(i.preventDefault(),this.slot===n.tt)this.ut();else{const i=n.V[n.tt].v.selector,e=Object.values(n.V).filter((({K:t})=>!t)).map((({v:t})=>t.selector)).join(", ");t.gt.lt(e),t.gt.bt(i)}}return!0}ft(i){if(n.ot)return!1;switch(i.preventDefault(),n.ct){case"cardsInOrbit":/rotation-container/.test($(this.D).parent()[0].id)&&(t.xt([this.D,$(this.D).parent()]),this.rt(),this.kt=parseInt(this.angle),this.$t=t.yt(this.D,{filter:"none"},{z:Math.abs(this.kt)>115?400:250,width:1.5*a.v.width,height:Math.abs(this.kt)>115?a.v.height+r.wt(50,"vh"):1.25*a.v.height,backgroundColor:"transparent",vt:Math.abs(this.kt)>115?-15:0,filter:"brightness(1.5) saturate(1.5) drop-shadow(30px 30px 10px rgba(0,0,0,0.7))",u:"power2.out",duration:.5,zt:this,St(){Math.abs(this.kt)>115?t.set(this.D,{backgroundPosition:"center bottom"}):t.set(this.D,{backgroundPosition:"center center"})}}));break;case"cardsDealt":case"cardsRevealed":if(this.K){if(this.jt)return!1;const{title:t,Ot:i}=a.styleMap[this.H];if(t.textShadow=r.Ct(t.textShadow,4,", "),i.textShadow=r.Ct(i.textShadow,2,", "),"major"!==this.T)return c(this.G,this,0,25,{It:t}),void c(`the ${this.name}`,this,95,25,{It:i});{const[e,s]=this.G.split(/\s+of\s+/);c(this.name,this,0,25,{It:t}),s?(c(`${e} of`,this,95,120,{It:i},{delay:.5}),c(s,this,105,100,{It:t},{delay:.75})):c(e,this,105,100,{It:i},{delay:.5})}}else this.slot===n.tt&&(this.Pt=t.timeline().to(this.D,{z:"+=50",duration:.5,u:"power4.inOut",scale:1.2},0).yt(`.tarot-card-main:not(#${this.id})`,{filter:"none"},{filter:"brightness(0.7) saturate(0.3)",scale:.8,duration:.5,u:"power4.inOut"},0))}return!0}Mt(i){switch(i.preventDefault(),n.ct){case"cardsInOrbit":return!!/rotation-container/.test($(this.D).parent()[0].id)&&t.to(this.D,{z:()=>150+t.o.random(0,50),width:a.v.width,height:a.v.height,backgroundColor:"transparent",vt:0,filter:"brightness(0.4) saturate(0.5) drop-shadow(30px 30px 10px rgba(0,0,0,0.7))",outline:"none",boxShadow:"none",u:"power2.out",duration:.5,delay:.25,zt:this,Zt(){t.set(this.D,{backgroundPosition:"center center"}),/rotation-container/.test($(this.D).parent()[0].id)&&t.gt.Et(this.D),t.xt(".rotation-container"),t.gt.Bt("#rotation-container-0",{Dt:"+=360",delay:0}),t.gt.Bt("#rotation-container-1",{Dt:"-=360",delay:0})}});case"cardsDealt":case"cardsRevealed":return this.Pt?.reverse();default:return!1}}Ft(){t.set(this.D,{Rt:-50,Ut:-50,x:this.x,y:this.y,z:this.z,height:this.height,width:this.width,backgroundImage:this.J,backgroundSize:`${this.width}px ${this.height}px`,pointerEvents:"all",opacity:0,Xt:!0}),$(this.D).click(this.ht.bind(this)),$(this.D).hover(this.ft.bind(this),this.Mt.bind(this))}dt(){const e=n._t;e&&(n.V[e].v=this,this.slot=e,t.to(this.D,{vt:0,z:400,duration:.25,u:"expo.in",zt:this,St(){t.set(".tarot-card-main",{pointerEvents:5===e?"none":"all"})},Zt(){t.xt(this.D);const s=i.getState(this.D,"boxShadow, filter, rotationZ");$(this.D).appendTo("#card-layer"),t.set(this.D,{Dt:0,z:0,height:a.v.height,width:a.v.width,scale:1,boxShadow:"5px 5px 5px rgba(0,0,0,0.4)",filter:"none",...n.V[e].Ht}),i.from(s,{duration:2,u:"expo.out",absolute:!0,Tt:!0,Gt:!0,scale:!0,zt:this,Zt(){t.set(this.D,{backgroundPosition:"center center"}),5===e&&(t.xt(".canvas-layer, .canvas-layer *"),t.set(".tarot-card-main",{pointerEvents:"all"}),h(a.Wt.Nt))}})}}))}ut(i){this.K=!0,n.et.qt[this.slot]=this.it,t.to(this.D,{duration:0,u:"circ",backgroundImage:this.J,zt:this,Zt(){5===this.slot&&(this.Pt?.reverse(),h(a.Wt.At))}})}}